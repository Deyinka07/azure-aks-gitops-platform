# Azure Pipeline for audiobookshelf-custom
# Build and push to Azure Container Registry

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - audiobookshelf-custom/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Container registry connection (keep this - it's correct!)
  dockerRegistryServiceConnection: 'db1f1afb-9b28-41fc-8c1f-64d008c51a85'
  
  # Fixed values
  imageRepository: 'audiobookshelf-custom'
  containerRegistry: 'deyinkaacr.azurecr.io'
  dockerfilePath: 'audiobookshelf-custom/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push'
    jobs:
      - job: BuildJob
        displayName: 'Build Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build and push image to ACR'
            inputs:
              command: 'buildAndPush'
              repository: '$(imageRepository)'
              dockerfile: '$(dockerfilePath)'
              containerRegistry: '$(dockerRegistryServiceConnection)'
              tags: |
                $(tag)
                latest
          
          - script: |
              echo "‚úÖ Image built and pushed successfully!"
              echo "üì¶ Registry: $(containerRegistry)"
              echo "üè∑Ô∏è  Image: $(imageRepository):$(tag)"
            displayName: 'Build Report'